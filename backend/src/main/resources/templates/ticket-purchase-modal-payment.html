<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ticket Modal Payment</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div id="match">
        <ul>
            <li id="match-info">GS MMS VS 한국전력</li>
            <li id="match-stadium">서울하이체육관</li>
            <li id="match-date">2024.10.24(목) 19:00</li>
        </ul>
    </div>

    <div id="selected-ticket">
        <table>
            <tr>##구역 @@매를 선택하셨습니다.</tr>
            <tr>
                <th>일반</th>
                <td><p>20,000</p> 원</td>
                <td><p>2</p> 매</td>
            </tr>
            <tr>
                <th>멤버십 할인</th>
                <td><p>30</p>%</td>
            </tr>
            <tr>
                <th>결제 금액</th>
                <td><p></p> 원</td>
            </tr>
        </table>
    </div>

    <div id="payment">

    </div>

    <div id="buttons">
        <button id="btn-pay">결제하기</button>
        <button id="btn-cancel">취소</button>
    </div>
    <script th:inline="javascript">
        $(document).ready(function(){
            $.ajax({
              url: "/purchase/section/{matchId}",
              type: "get",
              success: function(data) {
                // 받아온 데이터 저장
                let match = data.matchInfo;
                let availableSeats = data.availableSeatList;

                //1. 경기 정보 저장 및 변환
                let matchId = match.matchId;
                let matchDate = new Date(match.matchDate).toLocaleString(); // Date 객체로 변환 후 포맷팅
                let matchTeam = match.matchTeam; // 데이터에서 직접 가져옴
                let matchStadium = match.matchStadium; // 데이터에서 직접 가져옴
                let thisTeam = "GS ITM"; // 예시 팀 이름
                let matchInfo = "";

                // 경기 정보 출력 방식 수정
                if (matchTeam === "서울하이체육관") {
                      matchInfo = thisTeam + " VS " + matchTeam;
                } else {
                      matchInfo = matchTeam + " VS " + thisTeam;
                }

                // 경기 날짜 및 정보 출력
                $('#match-date').text(matchDate);
                $('#match-info').text(matchInfo);
                $('#match-stadium').text(matchStadium);

                //2. zone과 섹션 정보를 테이블에 추가
                availableSeats.forEach(function(zone) {
                    // Zone 추가
                    let zoneRow = `<tr class="zone">
                        <td class="zone-name">${zone.zoneName}</td>
                        <td><p class="available-seat-zone">${zone.availableSeatAmount}</p>석</td>
                    </tr>`;
                    $('#seat-body').append(zoneRow);

                    // 각 Zone에 속한 Section 추가
                    zone.sections.forEach(function(section) {
                        let sectionRow = `<tr class="section">
                            <td class="section-name">${section.sectionName}</td>
                            <td>
                                - <input class="ticket-amount" type="number"/> +
                            </td>
                            <td><p class="available-seat-section">${section.availableSeatAmount}</p> 석</td>
                        </tr>`;
                        $('#seat-body').append(sectionRow);
                    });
                  });

                // 3. 결제하기 버튼 클릭 시 선택한 구역과 좌석 수 전송
                $('#btn-pay').on("click", function() {
                    // 선택한 구역과 좌석 수 정보를 모은 배열
                    let selectedSeats = [];

                    // 각 섹션에서 선택된 좌석 수를 가져오기
                    $('.section').each(function() {
                        const sectionName = $(this).find('.section-name').text(); // 섹션 이름
                        const ticketAmount = parseInt($(this).find('.ticket-amount').val()); // 사용자가 입력한 좌석 수

                        if (ticketAmount > 0) { // 사용자가 입력한 좌석 수가 0보다 클 경우에만
                            // 각 선택된 좌석 정보를 객체로 만들어 추가
                            selectedSeats.push({
                                matchId: matchId, // matchId 추가
                                sectionName: sectionName, // 섹션 이름 추가
                                ticketAmount: ticketAmount // 티켓 수량 추가
                            });
                        }
                    });

                    // 선택된 좌석 수가 없으면 경고
                    if (selectedSeats.length === 0) {
                        alert("구역을 선택해주세요.");
                        return;
                    }

                    // DTO를 서버로 전송
                    $.ajax({
                        url: "/ticket/purchase/payment",
                        type: "post",
                        contentType: "application/json",
                        data: JSON.stringify({
                            selectedSeats: selectedSeats // 선택된 좌석 정보 배열 전송
                        }),
                        success: function(response) {
                            console.log("Reservation successful:", response);
                            // 성공적인 응답 처리, 예: 결제 페이지로 이동
                            window.location.href = "/payment"; // 결제 페이지로 이동
                        },
                        error: function(xhr, status, error) {
                            console.error('Error during reservation:', error);
                        },
                    });
                });

                //취소 버튼 클릭 시 티켓 구매 페이지로 이동
                 $('#btn-cancel').on("click", function(){
                     location.href = '/ticket/purchase';
                 });
              },
              error: function(xhr, status, error) {
                  console.error('Error fetching matches:', error);
              }
          });
      });
    </script>
</body>
</html>