<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ticket Modal Payment</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div id="selected-ticket">
        <table>
            <tr>##구역 @@매를 선택하셨습니다.</tr>
            <tr>
                <th>일반</th>
                <td><p class="ticket-price">20,000</p> 원</td>
                <td><p class="ticket-amount">2</p> 매</td>
            </tr>
            <tr>
                <th>멤버십 할인</th>
                <td><p class="membership-name">24/25</p></td>
                <td><p class="membership-discount">30</p>%</td>
            </tr>
            <tr>
                <th>결제 금액</th>
                <td><p class="payment-amount"></p> 원</td>
            </tr>
        </table>
    </div>

    <div id="match">
        <ul>
            <li id="match-info">GS MMS VS 한국전력</li>
            <li id="match-stadium">서울하이체육관</li>
            <li id="match-date">2024.10.24(목) 19:00</li>
        </ul>
    </div>

    <div id="payment">
        <ul>
            <li>예매정보</li>
            <li></li>
        </ul>
        <table id="tb-ticket">
            <tr>
                <th>티켓 금액</th>
                <td class="ticket-total-price"><p>40,000</p>원</td>
            </tr>
            <tr>
                <th>멤버십 할인</th>
                <td><p class="membership-discount">30</p>%</td>
            </tr>
            <tr>
                <th>총 결제 금액</th>
                <td><p class="payment-amount">28,000</p>원</td>
            </tr>
        </table>
        <table id="tb-charge">
            <tr>
                <th>충전 금액</th>
                <td><p class="charged-price">50,000</p>원</td>
            </tr>
            <tr>
                <th>- 총 결제 금액</th>
                <td><p class="payment-amount">28,000</p>원</td>
            </tr>
            <tr>
                <th>충전 잔액</th>
                <td><p class="left-charge">22,000</p>원</td>
            </tr>
        </table>
    </div>

    <div id="buttons">
        <button id="btn-pay">예매하기</button>
        <button id="btn-cancel">취소</button>
    </div>
    <script th:inline="javascript">
        $(document).ready(function(){
            $.ajax({
              url: "/purchase/payment",
              type: "post",
              success: function(data) {
                //받은 데이터 저장
                let ticketSalesDTO = data.ticketSalesDto;
                let matchInfo = data.matchInfo;
                let userBalance = data.userBalance;
                let userMembership = data.userMembership;
                let ticketPrice = data.ticketPrice;

                //1. 예매 티켓 정보 출력
                $('.ticket-price').text(ticketPrice);
                $('.ticket-amount').text(ticketSalesDTO.getTicketDetailAmount());
                $('.membership-name').text(userMembership.get("membershipType"));
                $('.membership-discount').text(userMembership.get("membershipDiscount"));

                //결제 금액 계산
                let ticketAmount = ticketPrice*ticketSalesDTO.getTicketDetailAmount();
                let ticketTotalPrice = (100-userMembership.get("membershipDiscount"))*0.01*ticketPrice*ticketSalesDTO.getTicketDetailAmount();
                $('.payment-amount').text(ticketAmount);
                $('.ticket-total-price').text(ticketTotalPrice);

                //2. 충전 금액 정보 출력
                $('.charged-price').text();
                $('.left-charge').text(userBalance.getLeftMoney() - ticketAmount);

                //3. 경기 정보 출력
                var matchId = match.matchId; // match를 올바르게 정의해야 합니다.
                  var matchDate = new Date(match.matchDate).toLocaleString(); // Date 객체로 변환 후 포맷팅
                  var matchTeam = match.matchTeam; // 데이터에서 직접 가져옴
                  var matchStadium = match.matchStadium; // 데이터에서 직접 가져옴
                  var thisTeam = "GS ITM"; // 예시 팀 이름
                  var matchInfo = "";

                  // 경기 정보 출력 방식 수정
                  if (matchTeam === "서울하이체육관") {
                      matchInfo = thisTeam + " VS " + matchTeam;
                  } else {
                      matchInfo = matchTeam + " VS " + thisTeam;
                  }

                  // 경기 날짜 및 정보 출력
                  $('#match-date').text(matchDate);
                  $('#match-info').text(matchInfo);
                  $('#match-stadium').text(matchStadium);

                //예매하기 버튼 클릭 시 구매 티켓 정보 전송
                $('#btn-pay').on("click", function(){
                    $.ajax({
                        url : "/purchase/payment/completed",
                        type : "post",
                        contentType: "application/json",
                        data: JSON.stringify(ticketSalesDTO), // 선택된 좌석 정보 객체 전송
                        success: function(response) {
                            console.log("Reservation successful:", response);
                            // 성공적인 응답 처리, 마이 페이지로 이동
                            window.location.href = "/myPage/ticket";
                        },
                        error: function(xhr, status, error) {
                            console.error('Error during reservation:', error);
                        },
                    });
                });

                //취소 버튼 클릭 시 티켓 구매 페이지로 이동
                 $('#btn-cancel').on("click", function(){
                     location.href = '/ticket/purchase';
                 });
              },
              error: function(xhr, status, error) {
                  console.error('Error fetching matches:', error);
              }
          });
      });
    </script>
</body>
</html>